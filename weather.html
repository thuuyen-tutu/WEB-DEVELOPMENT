<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>D·ª± b√°o th·ªùi ti·∫øt Vi·ªát Nam (Tu·ªïi Tr·∫ª API)</title>
  <script src="tuoitre.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #0b1220; color: #e2e8f0; margin: 0; }
    header { background: #09101d; padding: 20px; text-align: center; color: #fff; font-size: 1.4em; font-weight: bold; }
    main { max-width: 950px; margin: 20px auto; background: #101a2b; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); padding: 20px; }
    select, button { padding: 10px; border-radius: 8px; border: none; }
    select { width: 250px; background: #132038; color: #e2e8f0; }
    button { background: #0078ff; color: #fff; cursor: pointer; margin-left: 10px; }
    button:hover { background: #005bcc; }
    .card { background: #0e1627; border-radius: 12px; padding: 20px; margin-top: 20px; }
    .temp { font-size: 3em; font-weight: bold; }
    .info { display: grid; grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap: 10px; margin-top: 15px; }
    .info div { background: #132544; border-radius: 8px; padding: 10px; text-align: center; }
    canvas { background: #132544; border-radius: 12px; margin-top: 15px; padding: 10px; }
    .hourly-box { display: flex; overflow-x: auto; gap: 10px; margin-top: 15px; }
    .hour-item { background: #132544; border-radius: 8px; padding: 10px; min-width: 100px; text-align: center; }
  </style>
</head>
<body>
  <header>üå§Ô∏è D·ª± b√°o th·ªùi ti·∫øt Vi·ªát Nam (Tu·ªïi Tr·∫ª API)</header>

  <main>
    <div style="display:flex;align-items:center;gap:10px;">
      <select id="province"></select>
      <button onclick="fetchWeather()">Xem th·ªùi ti·∫øt</button>
    </div>
    <div id="weather" class="card">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

    <div id="hourly-section" class="card" style="display:none;">
      <h3>üå¶Ô∏è Nhi·ªát ƒë·ªô theo khung gi·ªù</h3>
      <canvas id="hourlyChart" height="120"></canvas>
      <div id="hourlyList" class="hourly-box"></div>
    </div>
  </main>

  <script>
    const provinceSelect = document.getElementById("province");
    const weatherBox = document.getElementById("weather");
    const hourlySection = document.getElementById("hourly-section");

    // Load danh s√°ch t·ªânh t·ª´ tuoitre.js
    weatherData.names.forEach((name, i) => {
      const opt = document.createElement("option");
      opt.value = weatherData.ids[i];
      opt.textContent = name;
      provinceSelect.appendChild(opt);
    });

async function fetchWeather() {
  const id = provinceSelect.value;
  const name = provinceSelect.options[provinceSelect.selectedIndex].text;
  weatherBox.innerHTML = `‚è≥ ƒêang t·∫£i d·ªØ li·ªáu th·ªùi ti·∫øt cho <b>${name}</b>...`;
  hourlySection.style.display = "none";

  const api = `https://utils3.cnnd.vn/ajax/weatherinfo/${id}.htm`;
  const proxies = [
    "https://api.codetabs.com/v1/proxy/?quest=",
    "https://api.allorigins.win/raw?url=",
    "https://thingproxy.freeboard.io/fetch/"
  ];

  for (let proxy of proxies) {
    try {
      const url = proxy + encodeURIComponent(api);
      const res = await fetch(url);
      if (!res.ok) throw new Error("Proxy l·ªói ho·∫∑c kh√¥ng ph·∫£n h·ªìi");
      const data = await res.json();

      // ki·ªÉm tra s√¢u trong JSON
      const info =
        data?.Data?.data?.datainfo ||
        data?.data?.datainfo ||
        data?.datainfo ||
        data;

      renderWeather(info);

      // t√¨m hourly data
      let hourlyData =
        info?.hourly_temperature ||
        info?.data?.hourly_temperature ||
        data?.Data?.data?.hourly_temperature ||
        data?.data?.hourly_temperature ||
        [];

      if (!Array.isArray(hourlyData) && typeof hourlyData === "object") {
        hourlyData = Object.values(hourlyData);
      }

      if (hourlyData && hourlyData.length > 0) {
        renderHourly(hourlyData);
      } else {
        hourlySection.style.display = "none";
      }

      return;
    } catch (err) {
      console.warn("‚ùå L·ªói proxy:", proxy, err.message);
    }
  }

  weatherBox.innerHTML = `
    <div style="color:#ff6b6b">
      ‚ùå <b>L·ªói khi t·∫£i d·ªØ li·ªáu:</b> Failed to fetch<br>
      üëâ <a href="${api}" target="_blank" style="color:#4dabf7">M·ªü JSON</a> ƒë·ªÉ xem c·∫•u tr√∫c th·∫≠t.
    </div>`;
}



    function renderWeather(info) {
      weatherBox.innerHTML = `
        <h2>${info.location ?? "Kh√¥ng r√µ"} ‚Äî ${info.status ?? ""}</h2>
        <div class="temp">${info.temperature ?? "-"}¬∞C</div>
        <div class="info">
          <div><b>ƒê·ªô ·∫©m</b><br>${info.humidity ?? "-"}%</div>
          <div><b>Gi√≥</b><br>${info.wind?.index ?? "-"} km/h</div>
          <div><b>H∆∞·ªõng gi√≥</b><br>${info.windDirection ?? "-"}</div>
          <div><b>UV</b><br>${info.UV_index?.index ?? "-"} (${info.UV_index?.status ?? "-"})</div>
          <div><b>T·∫ßm nh√¨n</b><br>${info.visibility?.index ?? "-"} km</div>
          <div><b>M·∫∑t tr·ªùi</b><br>${info.sunrise ?? "-"} ‚Üí ${info.sunset ?? "-"}</div>
        </div>
        <br>
        <b>Nhi·ªát ƒë·ªô cao/th·∫•p:</b> ${info.high ?? "-"}¬∞ / ${info.low ?? "-"}¬∞<br>
        <b>Ng√†y:</b> ${info.currentDate ?? "-"}
      `;
    }

function renderHourly(hourlyData) {
  if (!hourlyData || hourlyData.length === 0) {
    hourlySection.style.display = "none";
    return;
  }
  hourlySection.style.display = "block";
  const hourlyList = document.getElementById("hourlyList");
  hourlyList.style.display = "flex";
  hourlyList.style.overflowX = "auto";
  hourlyList.style.gap = "15px";

  hourlyList.innerHTML = hourlyData.map((h, i) => {
    const timeLabel = i === 0 ? "Hi·ªán t·∫°i" : `${h.time}:00`;
    const icon =
      h.status?.includes("m∆∞a")
        ? "üåßÔ∏è"
        : h.status?.includes("n·∫Øng")
        ? "‚òÄÔ∏è"
        : h.status?.includes("m√¢y")
        ? "‚õÖ"
        : "üå§Ô∏è";

    return `
      <div class="hour-card" style="
        flex: 0 0 130px;
        background: linear-gradient(180deg, #1a2a4a, #0f1b33);
        border-radius: 12px;
        padding: 12px;
        color: #f0f4ff;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      ">
        <div style="font-weight:bold;">${timeLabel}</div>
        <div style="margin:6px 0;font-size:0.9em;">üíß ${h.humidity ?? "-"}%</div>
        <div style="font-size:2em;">${icon}</div>
        <div style="margin-top:4px;">${h.status ?? "‚Äî"}</div>
        <div style="margin-top:8px;font-size:1.1em;">
          ${h.temperature ?? "-"}¬∞ / ${h.tempmax ?? h.temperature ?? "-"}¬∞C
        </div>
      </div>
    `;
  }).join("");
}

  </script>
</body>
</html>
